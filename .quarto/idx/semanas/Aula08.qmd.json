{"title":"Análise de Sobrevivência","markdown":{"yaml":{"title":"Análise de Sobrevivência","subtitle":"Modelos semi-paramétrico de Cox","author":"Ricardo Accioly","format":"html"},"headingText":"Introdução","containsRefs":false,"markdown":"\n\n\nVamos usar neste exemplo dados da biblioteca survival.\n\nOs dados são de sobrevivência de pacientes com cancer de pulmão em estágio avançado do North Central Cancer Treatment Group.\n\n\\- inst: Códico da Intituição\n\n\\- time: Tempo de sobrevivência em dias\n\n\\- status: 1=censurado, 2=morto\n\n\\- age: Idade em anos\n\n\\- sex: 1=Homem 2 = Mulher\n\n\\- ph.ecog: escore ecog 0=bom 5=morto\n\n\\- ph.karno: escore de Karnofsky (ruim=0-bom=100) definido pelo médico\n\n\\- pat.karno: escore de Karnofsky definido pelo paciente\n\n\\- meal.cal: Calorias consumidas nas refeições\n\n\\- wt.loss: Perda de peso nos últimos seis meses (libras)\n\n### Carregando os dados\n\n```{r ex_1}\nlibrary(survival)\ndados <- lung\nstr(dados)\nsummary(dados)\n\n```\n\n### Verificação de dados faltantes\n\n```{r ex_2}\nsum(complete.cases(lung))\nlibrary(dplyr)\ndados <- dados %>% na.omit(dados)\nsummary(dados)\n```\n\n## Modelo Semi-paramétrico de Cox\n\n```{r}\najuste1 <- coxph(Surv(time, status) ~ age + sex + ph.ecog +\n                   ph.karno + pat.karno + meal.cal + wt.loss, data = dados)\nsummary(ajuste1)\nlogLik(ajuste1)\n\n```\n\n## Usando o teste de Wald e da razão de verossimilhança\n\nO teste de Wald avalia a estatística z, que no caso acima indica que diversas variáveis não são significativas, por exemplo, meat.cal, age, pat.karno.\n\nVamos eliminar somente meat.cal e fazer o teste da razão de verossimilhança para confirmarmos que ela não é estatísticamente significativa.\n\n```{r}\najuste2 <- coxph(Surv(time, status) ~ age + sex + ph.ecog +\n                   ph.karno + pat.karno + wt.loss, data = dados)\nlogLik(ajuste2)\n\nTRV <- 2*(logLik(ajuste1) - logLik(ajuste2))\npchisq(TRV[1],1, lower.tail = FALSE)\n```\n\nO resultado acima confirma que o modelo não é afetado pela retirada de meat.cal, ou seja, ela não é estatísticamente significativa.\n\n## Automatizando ajuste\n\n```{r}\nlibrary(MASS)\najuste3 <- stepAIC(ajuste1, direction=\"backward\", trace=FALSE)\nsummary(ajuste3)\n```\n\nVeja que wt.loss e ph.karno são marginalmente significativas. pat.karno tem p-valor acima de 0,10 o que normalmente indicaria sua retirada do modelo.\n\n## Usando o BIC\n\n```{r}\nlibrary(MASS)\nn_eventos <- sum(dados$status)\najuste4 <- stepAIC(ajuste1, direction=\"backward\", k= log(n_eventos), trace=FALSE)\nsummary(ajuste4)\n```\n\n## Informações do Ajuste\n\n```{r}\ncoef(ajuste4)\nlogLik(ajuste4)\n```\n\n## Tempos Idênticos\n\n```{r}\najuste5 <- coxph(Surv(time,status==2) ~ sex + ph.ecog , \n                 ties= \"efron\", \n                 data=dados)\najuste6 <- coxph(Surv(time,status==2) ~ sex + ph.ecog , \n                 ties= \"breslow\", \n                 data=dados)\najuste7 <- coxph(Surv(time,status==2) ~ sex + ph.ecog , \n                 ties= \"exact\", \n                 data=dados)\ndif_met <- rbind(coef(ajuste5), coef(ajuste6), coef(ajuste7))\nrow.names(dif_met) <- c(\"Efron\", \"Breslow\", \"Exact\")\nknitr::kable(dif_met)\n```\n\n## Avaliando Ajuste\n\n```{r, message=FALSE}\nav1 <- survfit(Surv(time, status) ~ sex, data = dados)\nav1.tab <- summary(av1)\nplot(log(av1.tab$time),log(-log(av1.tab$surv)),\ncol = av1.tab$strata, xlab = \"log(t)\", ylab = \"log(-log(S))\",\npch = 20)\nlegend(\"bottomright\", bty = \"n\", lty = 1, col = c(1:2),\nlegend = sprintf(\"Sexo %d\", 1:2))\nav2 <- survfit(Surv(time, status) ~ ph.ecog, data = dados)\nav2.tab <- summary(av2)\nplot(log(av2.tab$time),log(-log(av2.tab$surv)),\ncol = av2.tab$strata, xlab = \"log(t)\", ylab = \"log(-log(S))\",\npch = 20)\nlegend(\"bottomright\", bty = \"n\", lty = 1, col = c(1,2,3,4),\nlegend = sprintf(\"Ecog %d\", 0:3))\n\n```\n\n## Resíduos de Cox-Snell\n\n```{r, message=FALSE}\nlibrary(car)\ncox.snell <- abs(dados$status - ajuste4$residuals)\nqqPlot(cox.snell, dist = \"exp\", rate = mean(cox.snell))\n```\n\n## Resíduos de Schoenfeld\n\n```{r}\ncox.zph(ajuste4)\nresid.sch <- cox.zph(ajuste4)\npar(mfrow=c(1,3))\nplot(resid.sch)\n```\n\n## Modelo de Cox Estratificado\n\n```{r}\najuste4_E <- coxph(Surv(time, status) ~ sex + strata(ph.ecog), data=dados)\nsummary(ajuste4_E)\n```\n\n```{r}\najuste_aux <- survfit(ajuste4_E)\nplot(ajuste_aux, mark.time=FALSE, col=c(1:4), lwd=3, las=1, bty='n', xlab=\"Tempo (dias)\", ylab=\"S(t)\")\nniveis <- sort(unique(dados$ph.ecog))\nlegend(\"topright\", levels(factor(niveis)), lwd=3, col=c(1:6))\n```\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":"auto","echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"wrap","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"output-file":"Aula08.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.2.269","editor":"visual","theme":{"light":["cosmo","../theme.scss"],"dark":["cosmo","../theme-dark.scss"]},"mainfont":"Atkinson Hyperlegible","code-copy":true,"title":"Análise de Sobrevivência","subtitle":"Modelos semi-paramétrico de Cox","author":"Ricardo Accioly"},"extensions":{"book":{"multiFile":true}}}}}