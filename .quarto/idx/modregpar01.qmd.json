{"title":"Análise de Sobrevivência","markdown":{"yaml":{"title":"Análise de Sobrevivência","subtitle":"Modelos de regressão paramétricos","author":"Ricardo Accioly","format":"html"},"headingText":"Introdução","containsRefs":false,"markdown":"\n\n\nNesta etapa vamos começar a trabalhar com modelos de regressão paramétricos.\n\nOs modelos que vamos ver se denominam modelos de tempo de falha (vida) acelerado TFA (AFT).\n\nO conjunto de dados a seguir chamado \"anderson.xlsx\" consiste em tempos de remissão em 42 pacientes com leucemia, metade dos quais recebem uma certa nova terapia de tratamento e a outra metade recebe uma terapia de tratamento padrão. A variável de exposição de interesse é o tratamento (Rx = 0 se novo tratamento, Rx = 1 se tratamento padrão).\n\nDuas outras variáveis para controle como potenciais confundidores são a contagem de glóbulos brancos (ou seja, logwbc) e sexo. O status de falha é definido pela variável recaída (0 se censurado, 1 se falhar).\n\n### Carregando os dados\n\n```{r ex_1}\nlibrary(survival)\nlibrary(readxl)\ndados <- read_xlsx(\"anderson.xlsx\", col_names = TRUE )\nsummary(dados)\n\n```\n\n### Ajuste Não Paramétrico\n\n```{r ex_2}\nekm <- survfit(Surv(tempo,status)~Rx, data=dados)\ntempo <- ekm$time\nst <- ekm$surv\nsummary(ekm)\nplot(ekm, xlab=\"Tempo (meses)\",ylab=\"S(t) estimada\")\n```\n\n## Modelo Exponencial\n\n```{r}\nleuc.exp.comp <- survreg(Surv(tempo, status) ~ sexo + logwbc + Rx, data = dados, dist = \"exponential\")\nsummary(leuc.exp.comp)\n```\n\n## Automatizando ajuste\n\n```{r}\nlibrary(MASS)\nleuc.exp.sel <- stepAIC(leuc.exp.comp, ditection=\"backward\")\nsummary(leuc.exp.sel)\n```\n\n## Fazendo Previsões\n\n```{r}\nnovosdados <- data.frame(logwbc=c(2,2), Rx=c(0,1))\npredict(leuc.exp.sel, type=\"lp\", newdata=novosdados)\n```\n\n## Tempo Mediano\n\n```{r}\nprev1 <-predict(leuc.exp.sel, type=\"quantile\", newdata=novosdados, p=0.5)\nprev1\nprev1[1]/prev1[2]\n```\n\n## Comparando com outro quantil\n\n```{r}\nprev2 <-predict(leuc.exp.sel, type=\"quantile\", newdata=novosdados, p=0.7)\nprev2\nprev2[1]/prev2[2]\n```\n\n## Verificando o modelo\n\n```{r}\nlibrary(car)\npar(mfrow = c(1, 2), cex = 0.6)\npred.lin <- predict(leuc.exp.sel, type = \"lp\")[dados$status == 1]\nlog.resid <- log(dados$tempo[dados$status == 1]) - pred.lin\nplot(pred.lin, log.resid, main = \"Grafico TA\",\nxlab = \"log(valores ajustados)\", ylab = \"log(residuos)\")\nqqPlot(log.resid, dist = \"norm\", sd=leuc.exp.sel$scale, \nmain = \"Grafico Q-Q\", xlab = \"Quantis teoricos Exponencial\", ylab = \"Quantis empiricos\")\n```\n\n## Modelo Weibull\n\n```{r}\nleuc.wei.comp <- survreg(Surv(tempo, status) ~ sexo + logwbc + Rx, data = dados, dist = \"weibull\")\nsummary(leuc.wei.comp)\n```\n\n## Análise de resíduos\n\n```{r}\n##=====================================================================\nqq.reg.resid.r<-function(data,time,status,fit,quantile,xlab){\n##=================================\n## Purpose: For parametric regression models, this constructs a\n##          qq-plot of ordered residuals e_i=(y_i-yhat_i)/sigmahat against\n##          the log-parametric standard quantiles z_i of either the\n##          \"weibull\", \"lognormal\", or \"loglogistic\" distribution.\n##--------------------------------------------------------------------------\n## NOTE:  This can also be used for fitting a single sample of survival\n##        times to a parametric model. Since there are no covariates\n##        remember to type survReg(Surv(...,...)~1,dist=\"...\",data=...) \n##        in order to estimate the intercept mu.\n##---------------------------------------------------------------------------\n## Arguments:   data = data.frame\n##              time = survival time variable name in data.frame\n##              status = name of status variable in data.frame\n##              fit = a survreg object\n##              quantile = \"qweibull\" or \"qnorm\" or \"qlogis\"  \n##              xlab = \"type your label\" E.g., \"standard extreme value quantiles\"\n##------------------------------------------------------------------------------\n## Author: Mara Tableman, Revises: 6 March, 2013\n##==============================================================================\ntemp<-data\ntemp$time<-time\ntemp$status<-status\ntemp$ei<-(log(temp$time)-predict(fit,type=\"lp\"))/fit$scale\ntemp<-temp[order(temp$ei), ]\ncon<-abs(min(temp$ei))+.00001\ntemp$ei<-temp$ei+con \nkm.fit<-survfit(Surv(ei,status)~1,data=temp)\n##temp$km.surv<-summary(km.fit,censor=T)$surv\ntemp$km.surv<-summary(km.fit, time=temp$ei, extend=T)$surv\nif (quantile == \"qweibull\") {\nzi<-as.numeric(qweibull(1-temp$km.surv,1,1))\nk<-nrow(temp)\nfor (i in 1:k){\n\tif (zi[i]!=-Inf && zi[i]!=Inf ) zi[i]<-log(zi[i])\n}\ntemp$zi<-zi\nfor(i in 1:k){ if (temp$zi[i]==-Inf)\n{\tsurv.max.1<-max(temp$km.surv[temp$status==1])\n\td<-1-surv.max.1\n\tsurv.pu<-1-d/2\t\n\ttemp$zi[i]<-log(qweibull(1-surv.pu,1,1))}\n}\nfor (i in 1:k){ if (temp$zi[i]==Inf)\n{  d<-min(temp$km.surv[temp$km.surv > 0])\n\tsurv.pl<-d/2\n\ttemp$zi[i]<-log(qweibull(1-surv.pl,1,1))}\n}\n}\nif (quantile == \"qlogis\") {\nzi<-as.numeric(qlogis(1-temp$km.surv,0,1))\nk<-nrow(temp)\nfor (i in 1:k){\n\tif (zi[i]!=-Inf && zi[i]!=Inf ) zi[i]<-zi[i]\n}\ntemp$zi<-zi\nfor(i in 1:k){ if (temp$zi[i]==-Inf)\n{\tsurv.max.1<-max(temp$km.surv[temp$status==1])\n\td<-1-surv.max.1\n\tsurv.pu<-1-d/2\t\n\ttemp$zi[i]<-qlogis(1-surv.pu,0,1)}\n}\nfor (i in 1:k){ if (temp$zi[i]==Inf)\n{  d<-min(temp$km.surv[temp$km.surv > 0])\n\tsurv.pl<-d/2\n\ttemp$zi[i]<-qlogis(1-surv.pl,0,1)}\n}\n}\n if (quantile == \"qnorm\"){ \nzi<-as.numeric(qnorm(1-temp$km.surv,0,1))\nk<-nrow(temp)\nfor (i in 1:k){\n\tif (zi[i]!=-Inf && zi[i]!=Inf ) zi[i]<-zi[i]\n}\ntemp$zi<-zi\nfor(i in 1:k){ if (temp$zi[i]==-Inf)\n{\tsurv.max.1<-max(temp$km.surv[temp$status==1])\n\td<-1-surv.max.1\n\tsurv.pu<-1-d/2\t\n\ttemp$zi[i]<-qnorm(1-surv.pu,0,1)}\n}\nfor (i in 1:k){ if (temp$zi[i]==Inf)\n{  d<-min(temp$km.surv[temp$km.surv > 0])\n\tsurv.pl<-d/2\n\ttemp$zi[i]<-qnorm(1-surv.pl,0,1)}\n}\n}\n temp$ei<-temp$ei-con\n##print(temp)\nplot(temp$zi,temp$ei,xlab=xlab,ylab=\"ordered ei residuals\",type=\"n\",xlim=c(min(temp$zi),max(temp$zi)),ylim=c(min(temp$ei),max(temp$ei)+.15))\npoints(temp$zi[temp$status==0],temp$ei[temp$status==0],pch=\".\",cex=3)\npoints(temp$zi[temp$status==1],temp$ei[temp$status==1],pch=\"o\",cex=1)\nlines(temp$zi[temp$status==1],temp$ei[temp$status==1],lty=1,lwd=1)\nk<-nrow(temp)\nfor(i in 1:k)\n{ if (temp$status[i]==0)\narrows(temp$zi[i],temp$ei[i],temp$zi[i],temp$ei[i]+.15,code=2,length=.12,lwd=2.01)}\nabline(a=0,b=1,lty=4,lwd=2)\nusr<-par(\"usr\")\narrows(.9*usr[1]+.1*usr[2],.07*usr[3]+.93*usr[4],.9*usr[1]+.1*usr[2],.07*usr[3]+.93*usr[4]+.15,code=2,length=.12,lwd=2.01)\ntext(.8*usr[1]+.2*usr[2],.05*usr[3]+.95*usr[4],\"= censored\")\npoints(.9*usr[1]+.1*usr[2],.11*usr[3]+.89*usr[4],pch=\"o\")\ntext(.79*usr[1]+.21*usr[2],.1*usr[3]+.90*usr[4], \"= uncensored\") \non.exit()\n\"qq.reg.resid:done\"\n}\n\n\nqq.reg.resid.r(dados,dados$tempo,dados$status, leuc.wei.comp,\"qweibull\",\"standard extreme value quantiles\")\n##Example 2: \n##fit.weib<-survreg(Surv(weeks,status)~1,dist=\"weibull\",data=aml1)\n##qq.reg.resid.r(aml1,aml1$weeks,aml1$status,fit.weib,\"qweibull\",\"standard extreme value quantiles\")\n##==================================================\n```\n"},"formats":{"html":{"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"engine":"knitr"},"render":{"keep-tex":false,"keep-yaml":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[]},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"output-file":"modregpar01.html"},"language":{},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.0.37","editor":"visual","theme":"cosmo","title":"Análise de Sobrevivência","subtitle":"Modelos de regressão paramétricos","author":"Ricardo Accioly"},"extensions":{"book":{"multiFile":true}}}}}