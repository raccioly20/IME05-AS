{
  "hash": "23ec69e29706d4edd6bbe0b396098174",
  "result": {
    "markdown": "---\ntitle: \"Análise de Sobrevivência\"\nsubtitle: \"Modelos Paramétricos TFA (AFT)\"\nauthor: \"Ricardo Accioly\"\nformat:\n  revealjs:\n    width: 1600\n    height: 900 \n    theme: dark\n    slide-number: true\n    css: styles.css\n---\n\n\n## Modelos TFA\n\nO conjunto de dados carregados a seguir são de 238 pacientes viciados com heroína.\n\nOs pacientes foram tratados em duas clínicas (1 e 2), além disso foram coletadas informações sobre dose de medicamento ministrado no tratamento e se o paciente já havia sido preso ou não.\n\nOs tempos (`survt`) são em dias e o evento analisado foi o tempo até a saída da clínica (status=1) ou o tempo até o término de estudo (tempo censurado (status=0).\n\n-   id: Identificação do paciente\n-   clinic: clinica em que ocorreu o tratamento\n-   survt: tempo até a saída da clínica (dias)\n-   status: censoring status 0=censored (censurado), 1=evento\n-   prison: 0= se nunca foi preso e 1= se já foi preso\n-   dose: dose do medicamento ministradp\n\n## Carregando os dados\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nlibrary(survival)\nlibrary(readxl)\ndados <- read_xlsx(\"heroina.xlsx\", col_names = TRUE )\nsummary(dados)\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n       id             clinic          status           survt       \n Min.   :  1.00   Min.   :1.000   Min.   :0.0000   Min.   :   2.0  \n 1st Qu.: 65.25   1st Qu.:1.000   1st Qu.:0.0000   1st Qu.: 171.2  \n Median :131.50   Median :1.000   Median :1.0000   Median : 367.5  \n Mean   :134.13   Mean   :1.315   Mean   :0.6303   Mean   : 402.6  \n 3rd Qu.:205.75   3rd Qu.:2.000   3rd Qu.:1.0000   3rd Qu.: 585.5  \n Max.   :266.00   Max.   :2.000   Max.   :1.0000   Max.   :1076.0  \n     prison            dose      \n Min.   :0.0000   Min.   : 20.0  \n 1st Qu.:0.0000   1st Qu.: 50.0  \n Median :0.0000   Median : 60.0  \n Mean   :0.4664   Mean   : 60.4  \n 3rd Qu.:1.0000   3rd Qu.: 70.0  \n Max.   :1.0000   Max.   :110.0  \n```\n:::\n:::\n\n\n## Avaliando presença de dados ausentes\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nnrow(dados)\nsum(complete.cases(dados))\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 238\n[1] 238\n```\n:::\n:::\n\n\n## Ajuste do Modelo Exponencial\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\najustExp <- survreg(Surv(survt,status)~1,dist='exponential', data=dados)\najustExp\nalfa <- exp(ajustExp$coefficients[1])\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\nsurvreg(formula = Surv(survt, status) ~ 1, data = dados, dist = \"exponential\")\n\nCoefficients:\n(Intercept) \n   6.459508 \n\nScale fixed at 1 \n\nLoglik(model)= -1118.9   Loglik(intercept only)= -1118.9\nn= 238 \n```\n:::\n:::\n\n\n## Ajuste do Modelo Weibull\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\najustWei <- survreg(Surv(survt, status)~1,dist='weibull', data=dados)\najustWei\nalfaw <- exp(ajustWei$coefficients[1])\nbetaw <- 1/ajustWei$scale\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\nsurvreg(formula = Surv(survt, status) ~ 1, data = dados, dist = \"weibull\")\n\nCoefficients:\n(Intercept) \n   6.425148 \n\nScale= 0.8153819 \n\nLoglik(model)= -1114.9   Loglik(intercept only)= -1114.9\nn= 238 \n```\n:::\n:::\n\n\n## Ajuste do Modelo Lognormal\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\najustLog <- survreg(Surv(survt,status)~1,dist='lognorm', data=dados)\najustLog\nmu <- ajustLog$icoef[1]\nsigma <- exp(ajustLog$icoef[2])\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\nsurvreg(formula = Surv(survt, status) ~ 1, data = dados, dist = \"lognorm\")\n\nCoefficients:\n(Intercept) \n   6.059725 \n\nScale= 1.210284 \n\nLoglik(model)= -1123.7   Loglik(intercept only)= -1123.7\nn= 238 \n```\n:::\n:::\n\n\n## Ajuste do Modelo Loglogístico\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\najustLogl <- survreg(Surv(survt,status)~1, data=dados, dist='loglogistic')\najustLogl\nmu1 <- ajustLogl$icoef[1]\nsigma1 <- exp(ajustLogl$icoef[2])\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\nsurvreg(formula = Surv(survt, status) ~ 1, data = dados, dist = \"loglogistic\")\n\nCoefficients:\n(Intercept) \n    6.09544 \n\nScale= 0.6637981 \n\nLoglik(model)= -1120   Loglik(intercept only)= -1120\nn= 238 \n```\n:::\n:::\n\n\n## Comparação dos Modelos {.scrollable}\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nekm <- survfit(Surv(survt,status)~1, data=dados)\ntempo <- ekm$time\nst <- ekm$surv\nste <- exp(-tempo/alfa)\nstw <- exp(-(tempo/alfaw)^betaw)\nstln <- pnorm((-log(tempo) + mu)/sigma)\nstll <- plogis((-log(tempo) + mu1)/sigma1)\nknitr::kable(head(cbind(tempo,st,ste,stw,stln,stll),15))\n```\n````\n\n::: {.cell-output-display}\n| tempo|        st|       ste|       stw|      stln|      stll|\n|-----:|---------:|---------:|---------:|---------:|---------:|\n|     2| 1.0000000| 0.9968738| 0.9991153| 0.9999954| 0.9997080|\n|     7| 0.9957627| 0.9891009| 0.9958947| 0.9996619| 0.9980756|\n|    13| 0.9915254| 0.9798534| 0.9912492| 0.9980588| 0.9951244|\n|    17| 0.9872881| 0.9737364| 0.9878608| 0.9961610| 0.9927140|\n|    19| 0.9830508| 0.9706923| 0.9860991| 0.9949737| 0.9913963|\n|    26| 0.9788136| 0.9601126| 0.9796444| 0.9896895| 0.9862708|\n|    28| 0.9788136| 0.9571111| 0.9777293| 0.9878899| 0.9846741|\n|    29| 0.9745393| 0.9556138| 0.9767614| 0.9869468| 0.9838555|\n|    30| 0.9702650| 0.9541189| 0.9757869| 0.9859760| 0.9830239|\n|    33| 0.9659907| 0.9496482| 0.9728257| 0.9829067| 0.9804540|\n|    35| 0.9574421| 0.9466794| 0.9708222| 0.9807385| 0.9786809|\n|    37| 0.9531678| 0.9437198| 0.9687968| 0.9784805| 0.9768624|\n|    41| 0.9446192| 0.9378285| 0.9646851| 0.9737197| 0.9730969|\n|    47| 0.9403449| 0.9290603| 0.9583814| 0.9660499| 0.9671529|\n|    49| 0.9360706| 0.9261559| 0.9562475| 0.9633723| 0.9650990|\n:::\n:::\n\n\n## Comparação dos Modelos\n\n\n::: {.cell output-location='slide'}\n\n````{.cell-code}\n```{{r}}\n#| output-location: slide\n#| fig-width: 15\n#| fig-height: 8\npar(mfrow=c(2,2))\nplot(st,ste,pch=16,ylim=range(c(0.0,1)), xlim=range(c(0,1)), xlab = \"S(t): Kaplan-Meier\", ylab=\"S(t): exponencial\")\nlines(c(0,1), c(0,1), type=\"l\", lty=1)\nplot(st,stw,pch=16,ylim=range(c(0.0,1)), xlim=range(c(0,1)), xlab = \"S(t): Kaplan-Meier\",\n     ylab=\"S(t): Weibull\")\nlines(c(0,1), c(0,1), type=\"l\", lty=1)\nplot(st,stln,pch=16,ylim=range(c(0.0,1)), xlim=range(c(0,1)), xlab = \"S(t): Kaplan-Meier\",\n     ylab=\"S(t): log-normal\")\nlines(c(0,1), c(0,1), type=\"l\", lty=1)\nplot(st,stll,pch=16,ylim=range(c(0.0,1)), xlim=range(c(0,1)), \n     xlab = \"S(t): Kaplan-Meier\", ylab=\"S(t): loglogística\")\nlines(c(0,1), c(0,1), type=\"l\", lty=1)\n```\n````\n\n::: {.cell-output-display}\n![](Aula16_files/figure-revealjs/unnamed-chunk-8-1.png){width=1440}\n:::\n:::\n\n\n\n## Comparação dos Modelos\n\n\n\n::: {.cell output-location='slide'}\n\n````{.cell-code}\n```{{r}}\n#| output-location: slide\n#| fig-width: 15\n#| fig-height: 8\npar(mfrow=c(1,3))\ntab.np <- summary(ekm)\ninvst1 <- qnorm(tab.np$surv)\ninvst2 <- qlogis(tab.np$surv) \nplot(log(tab.np$time), log(-log(tab.np$surv)),\n     xlab=\"log(t)\", ylab=\"log(-log(S(t)))\", pch=20)\nplot(log(tab.np$time), invst1,\n     xlab=\"log(t)\", ylab=expression(Phi^-1*(S(t))), pch=20)\nplot(log(tab.np$time), invst2,\n     xlab=\"log(t)\", ylab=expression(Phi^-1*Logis*(S(t))), pch=20)\n```\n````\n\n::: {.cell-output-display}\n![](Aula16_files/figure-revealjs/unnamed-chunk-9-1.png){width=1440}\n:::\n:::\n\n\n## Modelo Weibull\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nTFAWei <- survreg(Surv(survt, status) ~ clinic + factor(prison) + dose,\n                   dist = \"weibull\", \n                   data=dados)\nsummary(TFAWei)\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nsurvreg(formula = Surv(survt, status) ~ clinic + factor(prison) + \n    dose, data = dados, dist = \"weibull\")\n                   Value Std. Error     z       p\n(Intercept)      4.10485    0.32806 12.51 < 2e-16\nclinic           0.70904    0.15722  4.51 6.5e-06\nfactor(prison)1 -0.22947    0.12079 -1.90   0.057\ndose             0.02443    0.00459  5.32 1.0e-07\nLog(scale)      -0.31495    0.06756 -4.66 3.1e-06\n\nScale= 0.73 \n\nWeibull distribution\nLoglik(model)= -1084.5   Loglik(intercept only)= -1114.9\n\tChisq= 60.89 on 3 degrees of freedom, p= 3.8e-13 \nNumber of Newton-Raphson Iterations: 7 \nn= 238 \n```\n:::\n:::\n\n\n## Previsões\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nnovosdados <- data.frame(clinic = c(\"1\", \"2\"),\n                         prison = factor(c(0, 0)), dose = c(60, 60))\nprevis <- predict(TFAWei, type = \"quantile\", \n                  newdata = novosdados, p = 0.5)\nprevis\nprevis[2]/previs[1]\nprevis <- predict(TFAWei, type = \"quantile\", \n                  newdata = novosdados, p = 0.7)\nprevis\nprevis[2]/previs[1]\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n       1        2 \n200.9142 408.2661 \n       2 \n2.032042 \n       1        2 \n300.6186 610.8697 \n       2 \n2.032042 \n```\n:::\n:::\n\n\n\n## Função auxiliar\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsmoothSEcurve <- function(yy, xx) {\n# usar depois de chamar um grafico\n# Ajusta um curva lowess curve com IC de 95%\n## Facilita a avaliação dos resíduos\nxx.list <- min(xx) + ((0:100)/100)*(max(xx) - min(xx))\nyy.xx <- predict(loess(yy ~ xx), se=T,\nnewdata=data.frame(xx=xx.list))\nlines(yy.xx$fit ~ xx.list, lwd=2)\nlines(yy.xx$fit -\nqt(0.975, yy.xx$df)*yy.xx$se.fit ~ xx.list, lty=2)\nlines(yy.xx$fit +\nqt(0.975, yy.xx$df)*yy.xx$se.fit ~ xx.list, lty=2)\n}\n```\n:::\n\n\n\n## Diagnóstico do Modelo\n\n\n::: {.cell output-location='slide'}\n\n````{.cell-code}\n```{{r}}\n#| output-location: slide\n#| fig-width: 15\n#| fig-height: 8\nlibrary(car)\npar(mfrow = c(1, 2), cex = 0.6)\npred.lin <- predict(TFAWei, type = \"lp\")[dados$status == 1]\nlog.resid <- log(dados$survt[dados$status == 1]) - pred.lin\nplot(pred.lin, log.resid, main = \"Grafico TA\",\nxlab = \"log(valores ajustados)\", ylab = \"log(residuos)\")\nsmoothSEcurve(log.resid, pred.lin)\nqqPlot(exp(log.resid), dist = \"weibull\",\nshape = 1/TFAWei$scale,\nmain = \"Grafico Q-Q\", xlab = \"Quantis teoricos Weibull\", ylab = \"Quantis empiricos\")\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 69  8\n```\n:::\n\n::: {.cell-output-display}\n![](Aula16_files/figure-revealjs/unnamed-chunk-13-1.png){width=1440}\n:::\n:::\n\n\n## Modelo Lognormal\n\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nTFALn <- survreg(Surv(survt, status) ~ clinic + factor(prison) + dose,\n                   dist = \"lognormal\", \n                   data=dados)\nsummary(TFALn)\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nsurvreg(formula = Surv(survt, status) ~ clinic + factor(prison) + \n    dose, data = dados, dist = \"lognormal\")\n                   Value Std. Error     z      p\n(Intercept)      3.40684    0.39769  8.57 <2e-16\nclinic           0.57649    0.17648  3.27 0.0011\nfactor(prison)1 -0.30904    0.15431 -2.00 0.0452\ndose             0.03367    0.00568  5.93  3e-09\nLog(scale)       0.07476    0.05930  1.26 0.2074\n\nScale= 1.08 \n\nLog Normal distribution\nLoglik(model)= -1097.8   Loglik(intercept only)= -1123.7\n\tChisq= 51.85 on 3 degrees of freedom, p= 3.2e-11 \nNumber of Newton-Raphson Iterations: 4 \nn= 238 \n```\n:::\n:::\n\n\n\n## Previsões\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nnovosdados <- data.frame(clinic = c(\"1\", \"2\"),\n                         prison = factor(c(0, 0)), dose = c(60, 60))\nprevis <- predict(TFALn, type = \"quantile\", \n                  newdata = novosdados, p = 0.5)\nprevis\nprevis[2]/previs[1]\nprevis <- predict(TFALn, type = \"quantile\", \n                  newdata = novosdados, p = 0.7)\nprevis\nprevis[2]/previs[1]\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n       1        2 \n227.5381 404.9681 \n       2 \n1.779782 \n       1        2 \n400.3836 712.5953 \n       2 \n1.779782 \n```\n:::\n:::\n\n\n\n## Diagnóstico do Modelo\n\n\n\n::: {.cell output-location='slide'}\n\n````{.cell-code}\n```{{r}}\n#| output-location: slide\n#| fig-width: 15\n#| fig-height: 8\npar(mfrow = c(1, 2), cex = 0.6)\npred.lin <- predict(TFALn, type = \"lp\")[dados$status == 1]\nlog.resid <- log(dados$survt[dados$status == 1]) - pred.lin\nplot(pred.lin, log.resid, main = \"Grafico TA\",\nxlab = \"log(valores ajustados)\", ylab = \"log(residuos)\")\nsmoothSEcurve(log.resid, pred.lin)\nqqPlot(log.resid, dist = \"norm\", sd=TFALn$scale, \nmain = \"Grafico Q-Q\", xlab = \"Quantis teoricos Lognormal\", ylab = \"Quantis empiricos\")\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n[1]  86 110\n```\n:::\n\n::: {.cell-output-display}\n![](Aula16_files/figure-revealjs/unnamed-chunk-16-1.png){width=1440}\n:::\n:::\n\n\n\n## Modeleo Loglogistico\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nTFALl <- survreg(Surv(survt, status) ~ clinic + factor(prison) + dose,\n                   dist = \"loglogistic\", \n                   data=dados)\nsummary(TFALl)\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nsurvreg(formula = Surv(survt, status) ~ clinic + factor(prison) + \n    dose, data = dados, dist = \"loglogistic\")\n                   Value Std. Error     z       p\n(Intercept)      3.56327    0.38945  9.15 < 2e-16\nclinic           0.58060    0.17157  3.38 0.00071\nfactor(prison)1 -0.29127    0.14396 -2.02 0.04305\ndose             0.03161    0.00552  5.73 1.0e-08\nLog(scale)      -0.53314    0.06863 -7.77 7.9e-15\n\nScale= 0.587 \n\nLog logistic distribution\nLoglik(model)= -1093.9   Loglik(intercept only)= -1120\n\tChisq= 52.18 on 3 degrees of freedom, p= 2.7e-11 \nNumber of Newton-Raphson Iterations: 4 \nn= 238 \n```\n:::\n:::\n\n\n\n## Previsões\n\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nnovosdados <- data.frame(clinic = c(\"1\", \"2\"),\n                         prison = factor(c(0, 0)), dose = c(60, 60))\nprevis <- predict(TFALl, type = \"quantile\", \n                  newdata = novosdados, p = 0.5)\nprevis\nprevis[2]/previs[1]\nprevis <- predict(TFALl, type = \"quantile\", \n                  newdata = novosdados, p = 0.7)\nprevis\nprevis[2]/previs[1]\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n       1        2 \n235.1125 420.1710 \n       2 \n1.787106 \n       1        2 \n386.5353 690.7797 \n       2 \n1.787106 \n```\n:::\n:::\n\n\n\n## Diagnóstico do Modelo\n\n\n::: {.cell output-location='slide'}\n\n````{.cell-code}\n```{{r}}\n#| output-location: slide\n#| fig-width: 15\n#| fig-height: 8\npar(mfrow = c(1, 2), cex = 0.6)\npred.lin <- predict(TFALl, type = \"lp\")[dados$status == 1]\nlog.resid <- log(dados$survt[dados$status == 1]) - pred.lin\nplot(pred.lin, log.resid, main = \"Grafico TA\",\nxlab = \"log(valores ajustados)\", ylab = \"log(residuos)\")\nsmoothSEcurve(log.resid, pred.lin)\nqqPlot(log.resid, dist = \"logis\", \nmain = \"Grafico Q-Q\", xlab = \"Quantis teoricos Logistica\", ylab = \"Quantis empiricos\")\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n[1]  86 110\n```\n:::\n\n::: {.cell-output-display}\n![](Aula16_files/figure-revealjs/unnamed-chunk-19-1.png){width=1440}\n:::\n:::\n\n\n## Usando o stepAIC\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nlibrary(MASS)\nTFAWei <- survreg(Surv(survt, status) ~ clinic + factor(prison) + dose,\n                   dist = \"weibull\", \n                   data=dados)\nTFAWei_AIC <- stepAIC(TFAWei, trace=FALSE)\nsummary(TFAWei_AIC)\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nsurvreg(formula = Surv(survt, status) ~ clinic + factor(prison) + \n    dose, data = dados, dist = \"weibull\")\n                   Value Std. Error     z       p\n(Intercept)      4.10485    0.32806 12.51 < 2e-16\nclinic           0.70904    0.15722  4.51 6.5e-06\nfactor(prison)1 -0.22947    0.12079 -1.90   0.057\ndose             0.02443    0.00459  5.32 1.0e-07\nLog(scale)      -0.31495    0.06756 -4.66 3.1e-06\n\nScale= 0.73 \n\nWeibull distribution\nLoglik(model)= -1084.5   Loglik(intercept only)= -1114.9\n\tChisq= 60.89 on 3 degrees of freedom, p= 3.8e-13 \nNumber of Newton-Raphson Iterations: 7 \nn= 238 \n```\n:::\n:::\n",
    "supporting": [
      "Aula16_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\r\n<script>\r\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\r\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\r\n  // slide changes (different for each slide format).\r\n  (function () {\r\n    // dispatch for htmlwidgets\r\n    function fireSlideEnter() {\r\n      const event = window.document.createEvent(\"Event\");\r\n      event.initEvent(\"slideenter\", true, true);\r\n      window.document.dispatchEvent(event);\r\n    }\r\n\r\n    function fireSlideChanged(previousSlide, currentSlide) {\r\n      fireSlideEnter();\r\n\r\n      // dispatch for shiny\r\n      if (window.jQuery) {\r\n        if (previousSlide) {\r\n          window.jQuery(previousSlide).trigger(\"hidden\");\r\n        }\r\n        if (currentSlide) {\r\n          window.jQuery(currentSlide).trigger(\"shown\");\r\n        }\r\n      }\r\n    }\r\n\r\n    // hookup for slidy\r\n    if (window.w3c_slidy) {\r\n      window.w3c_slidy.add_observer(function (slide_num) {\r\n        // slide_num starts at position 1\r\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\r\n      });\r\n    }\r\n\r\n  })();\r\n</script>\r\n\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}