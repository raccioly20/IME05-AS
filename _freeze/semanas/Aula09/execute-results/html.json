{
  "hash": "db5789b9726f975adbb13598426ce463",
  "result": {
    "markdown": "---\ntitle: \"Análise de Sobrevivência\"\nsubtitle: \"Modelos semi-paramétrico de Cox\"\nauthor: \"Ricardo Accioly\"\nformat:\n html:\n    code-link: true\n    fig-width: 9\n    fig-height: 7\n    fig-dpi: 300\nknitr:\n  opts_chunk: \n    out.width: 90%\n    comment: \"#>\"\n---\n\n\n### Introdução\n\nVamos usar neste exemplo dados da biblioteca survival.\n\nOs dados são de sobrevivência de pacientes com cancer de pulmão em estágio avançado do North Central Cancer Treatment Group.\n\n\\- inst: Códico da Intituição\n\n\\- time: Tempo de sobrevivência em dias\n\n\\- status: 1=censurado, 2=morto\n\n\\- age: Idade em anos\n\n\\- sex: 1=Homem 2 = Mulher\n\n\\- ph.ecog: escore ecog 0=bom 5=morto\n\n\\- ph.karno: escore de Karnofsky (ruim=0-bom=100) definido pelo médico\n\n\\- pat.karno: escore de Karnofsky definido pelo paciente\n\n\\- meal.cal: Calorias consumidas nas refeições\n\n\\- wt.loss: Perda de peso nos últimos seis meses (libras)\n\n### Carregando os dados\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(survival)\ndados <- lung\nstr(dados)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> 'data.frame':\t228 obs. of  10 variables:\n#>  $ inst     : num  3 3 3 5 1 12 7 11 1 7 ...\n#>  $ time     : num  306 455 1010 210 883 ...\n#>  $ status   : num  2 2 1 2 2 1 2 2 2 2 ...\n#>  $ age      : num  74 68 56 57 60 74 68 71 53 61 ...\n#>  $ sex      : num  1 1 1 1 1 1 2 2 1 1 ...\n#>  $ ph.ecog  : num  1 0 0 1 0 1 2 2 1 2 ...\n#>  $ ph.karno : num  90 90 90 90 100 50 70 60 70 70 ...\n#>  $ pat.karno: num  100 90 90 60 90 80 60 80 80 70 ...\n#>  $ meal.cal : num  1175 1225 NA 1150 NA ...\n#>  $ wt.loss  : num  NA 15 15 11 0 0 10 1 16 34 ...\n```\n:::\n\n```{.r .cell-code}\nsummary(dados)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#>       inst            time            status           age       \n#>  Min.   : 1.00   Min.   :   5.0   Min.   :1.000   Min.   :39.00  \n#>  1st Qu.: 3.00   1st Qu.: 166.8   1st Qu.:1.000   1st Qu.:56.00  \n#>  Median :11.00   Median : 255.5   Median :2.000   Median :63.00  \n#>  Mean   :11.09   Mean   : 305.2   Mean   :1.724   Mean   :62.45  \n#>  3rd Qu.:16.00   3rd Qu.: 396.5   3rd Qu.:2.000   3rd Qu.:69.00  \n#>  Max.   :33.00   Max.   :1022.0   Max.   :2.000   Max.   :82.00  \n#>  NA's   :1                                                       \n#>       sex           ph.ecog          ph.karno        pat.karno     \n#>  Min.   :1.000   Min.   :0.0000   Min.   : 50.00   Min.   : 30.00  \n#>  1st Qu.:1.000   1st Qu.:0.0000   1st Qu.: 75.00   1st Qu.: 70.00  \n#>  Median :1.000   Median :1.0000   Median : 80.00   Median : 80.00  \n#>  Mean   :1.395   Mean   :0.9515   Mean   : 81.94   Mean   : 79.96  \n#>  3rd Qu.:2.000   3rd Qu.:1.0000   3rd Qu.: 90.00   3rd Qu.: 90.00  \n#>  Max.   :2.000   Max.   :3.0000   Max.   :100.00   Max.   :100.00  \n#>                  NA's   :1        NA's   :1        NA's   :3       \n#>     meal.cal         wt.loss       \n#>  Min.   :  96.0   Min.   :-24.000  \n#>  1st Qu.: 635.0   1st Qu.:  0.000  \n#>  Median : 975.0   Median :  7.000  \n#>  Mean   : 928.8   Mean   :  9.832  \n#>  3rd Qu.:1150.0   3rd Qu.: 15.750  \n#>  Max.   :2600.0   Max.   : 68.000  \n#>  NA's   :47       NA's   :14\n```\n:::\n:::\n\n\n### Verificação de dados faltantes\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnrow(lung)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> [1] 228\n```\n:::\n\n```{.r .cell-code}\nsum(complete.cases(lung))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> [1] 167\n```\n:::\n\n```{.r .cell-code}\ndados <- na.omit(dados)\nsummary(dados)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#>       inst            time            status           age       \n#>  Min.   : 1.00   Min.   :   5.0   Min.   :1.000   Min.   :39.00  \n#>  1st Qu.: 3.00   1st Qu.: 174.5   1st Qu.:1.000   1st Qu.:57.00  \n#>  Median :11.00   Median : 268.0   Median :2.000   Median :64.00  \n#>  Mean   :10.71   Mean   : 309.9   Mean   :1.719   Mean   :62.57  \n#>  3rd Qu.:15.00   3rd Qu.: 419.5   3rd Qu.:2.000   3rd Qu.:70.00  \n#>  Max.   :32.00   Max.   :1022.0   Max.   :2.000   Max.   :82.00  \n#>       sex           ph.ecog          ph.karno        pat.karno     \n#>  Min.   :1.000   Min.   :0.0000   Min.   : 50.00   Min.   : 30.00  \n#>  1st Qu.:1.000   1st Qu.:0.0000   1st Qu.: 70.00   1st Qu.: 70.00  \n#>  Median :1.000   Median :1.0000   Median : 80.00   Median : 80.00  \n#>  Mean   :1.383   Mean   :0.9581   Mean   : 82.04   Mean   : 79.58  \n#>  3rd Qu.:2.000   3rd Qu.:1.0000   3rd Qu.: 90.00   3rd Qu.: 90.00  \n#>  Max.   :2.000   Max.   :3.0000   Max.   :100.00   Max.   :100.00  \n#>     meal.cal         wt.loss       \n#>  Min.   :  96.0   Min.   :-24.000  \n#>  1st Qu.: 619.0   1st Qu.:  0.000  \n#>  Median : 975.0   Median :  7.000  \n#>  Mean   : 929.1   Mean   :  9.719  \n#>  3rd Qu.:1162.5   3rd Qu.: 15.000  \n#>  Max.   :2600.0   Max.   : 68.000\n```\n:::\n:::\n\n\n## Modelo Semi-paramétrico de Cox\n\n\n::: {.cell}\n\n```{.r .cell-code}\najuste1 <- coxph(Surv(time, status) ~ age + sex + ph.ecog +\n                   ph.karno + pat.karno + meal.cal + wt.loss, data = dados)\nsummary(ajuste1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> Call:\n#> coxph(formula = Surv(time, status) ~ age + sex + ph.ecog + ph.karno + \n#>     pat.karno + meal.cal + wt.loss, data = dados)\n#> \n#>   n= 167, number of events= 120 \n#> \n#>                 coef  exp(coef)   se(coef)      z Pr(>|z|)   \n#> age        1.080e-02  1.011e+00  1.160e-02  0.931  0.35168   \n#> sex       -5.536e-01  5.749e-01  2.016e-01 -2.746  0.00603 **\n#> ph.ecog    7.395e-01  2.095e+00  2.250e-01  3.287  0.00101 **\n#> ph.karno   2.244e-02  1.023e+00  1.123e-02  1.998  0.04575 * \n#> pat.karno -1.207e-02  9.880e-01  8.116e-03 -1.488  0.13685   \n#> meal.cal   2.835e-05  1.000e+00  2.594e-04  0.109  0.91298   \n#> wt.loss   -1.420e-02  9.859e-01  7.766e-03 -1.828  0.06748 . \n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#>           exp(coef) exp(-coef) lower .95 upper .95\n#> age          1.0109     0.9893    0.9881    1.0341\n#> sex          0.5749     1.7395    0.3872    0.8534\n#> ph.ecog      2.0950     0.4773    1.3479    3.2560\n#> ph.karno     1.0227     0.9778    1.0004    1.0455\n#> pat.karno    0.9880     1.0121    0.9724    1.0038\n#> meal.cal     1.0000     1.0000    0.9995    1.0005\n#> wt.loss      0.9859     1.0143    0.9710    1.0010\n#> \n#> Concordance= 0.653  (se = 0.029 )\n#> Likelihood ratio test= 28.16  on 7 df,   p=2e-04\n#> Wald test            = 27.5  on 7 df,   p=3e-04\n#> Score (logrank) test = 28.31  on 7 df,   p=2e-04\n```\n:::\n\n```{.r .cell-code}\nlogLik(ajuste1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> 'log Lik.' -494.0344 (df=7)\n```\n:::\n:::\n\n\n## Usando o teste de Wald e da razão de verossimilhança\n\nO teste de Wald avalia a estatística z, que no caso acima indica que diversas variáveis não são significativas, por exemplo, meat.cal, age, pat.karno.\n\nVamos eliminar somente meat.cal e fazer o teste da razão de verossimilhança para confirmarmos que ela não é estatísticamente significativa.\n\n\n::: {.cell}\n\n```{.r .cell-code}\najuste2 <- coxph(Surv(time, status) ~ age + sex + ph.ecog +\n                   ph.karno + pat.karno + wt.loss, data = dados)\nlogLik(ajuste2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> 'log Lik.' -494.0404 (df=6)\n```\n:::\n\n```{.r .cell-code}\nTRV <- 2*(logLik(ajuste1) - logLik(ajuste2))\npchisq(TRV[1],1, lower.tail = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> [1] 0.9131696\n```\n:::\n:::\n\n\nO resultado acima confirma que o modelo não é afetado pela retirada de meat.cal, ou seja, ela não é estatísticamente significativa.\n\n## Automatizando ajuste\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(MASS)\najuste3 <- stepAIC(ajuste1, direction=\"backward\", trace=FALSE)\nsummary(ajuste3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> Call:\n#> coxph(formula = Surv(time, status) ~ sex + ph.ecog + ph.karno + \n#>     pat.karno + wt.loss, data = dados)\n#> \n#>   n= 167, number of events= 120 \n#> \n#>                coef exp(coef)  se(coef)      z Pr(>|z|)   \n#> sex       -0.558190  0.572244  0.199202 -2.802  0.00508 **\n#> ph.ecog    0.742983  2.102197  0.227604  3.264  0.00110 **\n#> ph.karno   0.020366  1.020575  0.011080  1.838  0.06604 . \n#> pat.karno -0.012401  0.987675  0.007978 -1.554  0.12008   \n#> wt.loss   -0.014494  0.985611  0.007693 -1.884  0.05957 . \n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#>           exp(coef) exp(-coef) lower .95 upper .95\n#> sex          0.5722     1.7475    0.3873    0.8456\n#> ph.ecog      2.1022     0.4757    1.3457    3.2841\n#> ph.karno     1.0206     0.9798    0.9987    1.0430\n#> pat.karno    0.9877     1.0125    0.9724    1.0032\n#> wt.loss      0.9856     1.0146    0.9709    1.0006\n#> \n#> Concordance= 0.658  (se = 0.029 )\n#> Likelihood ratio test= 27.28  on 5 df,   p=5e-05\n#> Wald test            = 26.89  on 5 df,   p=6e-05\n#> Score (logrank) test = 27.64  on 5 df,   p=4e-05\n```\n:::\n:::\n\n\nVeja que wt.loss e ph.karno são marginalmente significativas. pat.karno tem p-valor acima de 0,10 o que normalmente indicaria sua retirada do modelo.\n\n## Usando o BIC\n\n\n::: {.cell}\n\n```{.r .cell-code}\nn_eventos <- sum(dados$status)\najuste4 <- stepAIC(ajuste1, direction=\"backward\", k= log(n_eventos), trace=FALSE)\nsummary(ajuste4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> Call:\n#> coxph(formula = Surv(time, status) ~ sex + ph.ecog, data = dados)\n#> \n#>   n= 167, number of events= 120 \n#> \n#>            coef exp(coef) se(coef)      z Pr(>|z|)    \n#> sex     -0.5101    0.6004   0.1969 -2.591 0.009579 ** \n#> ph.ecog  0.4825    1.6201   0.1323  3.647 0.000266 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#>         exp(coef) exp(-coef) lower .95 upper .95\n#> sex        0.6004     1.6655    0.4082    0.8832\n#> ph.ecog    1.6201     0.6172    1.2501    2.0998\n#> \n#> Concordance= 0.641  (se = 0.031 )\n#> Likelihood ratio test= 19.48  on 2 df,   p=6e-05\n#> Wald test            = 19.35  on 2 df,   p=6e-05\n#> Score (logrank) test = 19.62  on 2 df,   p=5e-05\n```\n:::\n:::\n\n\n## Informações do Ajuste\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoef(ajuste4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#>        sex    ph.ecog \n#> -0.5100991  0.4825185\n```\n:::\n\n```{.r .cell-code}\nlogLik(ajuste4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> 'log Lik.' -498.3757 (df=2)\n```\n:::\n:::\n\n\n## Tempos Idênticos\n\n\n::: {.cell}\n\n```{.r .cell-code}\najuste5 <- coxph(Surv(time,status==2) ~ sex + ph.ecog , \n                 ties= \"efron\", \n                 data=dados)\najuste6 <- coxph(Surv(time,status==2) ~ sex + ph.ecog , \n                 ties= \"breslow\", \n                 data=dados)\najuste7 <- coxph(Surv(time,status==2) ~ sex + ph.ecog , \n                 ties= \"exact\", \n                 data=dados)\ndif_met <- rbind(coef(ajuste5), coef(ajuste6), coef(ajuste7))\nrow.names(dif_met) <- c(\"Efron\", \"Breslow\", \"Exact\")\nknitr::kable(dif_met)\n```\n\n::: {.cell-output-display}\n|        |        sex|   ph.ecog|\n|:-------|----------:|---------:|\n|Efron   | -0.5100991| 0.4825185|\n|Breslow | -0.5094047| 0.4823368|\n|Exact   | -0.5103502| 0.4832902|\n:::\n:::\n\n\nObserve que as diferenças entre os métodos são pequenas, não afetando a interpretação.\n\n## Avaliando Ajuste\n\n\n::: {.cell}\n\n```{.r .cell-code}\nav1 <- survfit(Surv(time, status) ~ sex, data = dados)\nav1.tab <- summary(av1)\nplot(log(av1.tab$time),log(-log(av1.tab$surv)),\ncol = av1.tab$strata, xlab = \"log(t)\", ylab = \"log(-log(S))\",\npch = 20)\nlegend(\"bottomright\", bty = \"n\", lty = 1, col = c(1:2),\nlegend = sprintf(\"Sexo %d\", 1:2))\n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/unnamed-chunk-7-1.png){width=90%}\n:::\n\n```{.r .cell-code}\nav2 <- survfit(Surv(time, status) ~ ph.ecog, data = dados)\nav2.tab <- summary(av2)\nplot(log(av2.tab$time),log(-log(av2.tab$surv)),\ncol = av2.tab$strata, xlab = \"log(t)\", ylab = \"log(-log(S))\",\npch = 20)\nlegend(\"bottomright\", bty = \"n\", lty = 1, col = c(1,2,3,4),\nlegend = sprintf(\"Ecog %d\", 0:3))\n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/unnamed-chunk-7-2.png){width=90%}\n:::\n:::\n\n\nNão temos indicação gráfica de não proporcionalidade das taxas de falhas\n\n## Resíduos de Cox-Snell\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(car)\ncox.snell <- abs(dados$status - ajuste4$residuals)\nqqPlot(cox.snell, dist = \"exp\", rate = mean(cox.snell))\n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/unnamed-chunk-8-1.png){width=90%}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n#> 37 18 \n#> 25 11\n```\n:::\n:::\n\n\nAlgum desvio na cauda direita\n\n## Resíduos de Schoenfeld\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncox.zph(ajuste4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#>         chisq df     p\n#> sex      1.24  1 0.266\n#> ph.ecog  5.27  1 0.022\n#> GLOBAL   6.19  2 0.045\n```\n:::\n\n```{.r .cell-code}\nresid.sch <- cox.zph(ajuste4)\npar(mfrow=c(1,3))\nplot(resid.sch)\n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/unnamed-chunk-9-1.png){width=90%}\n:::\n:::\n\n\nNão há indicação significativa de não proporcionalidade.\n\nSomente ph.ecog apresenta um p valor mais baixo indicando um potencial comportamento de não proporcionalidade. A hipótese nula é que o coeficiente angular é zero.\n\n## Resíduos Martingale e Deviance\n\nOs resíduos Martingale servem para avaliar alguma forma de não lineridade do modelo e os resíduoas deviance para verificarmos a presença de outliers.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow=c(1,2))\nmart<- residuals(ajuste4,type=\"martingale\")\ndev<- residuals(ajuste4,type=\"deviance\")\nplot(mart, ylab=\"res\",pch=20)\ntitle(\"Resıduos Martingale\")\nplot(dev, ylab=\"res\",pch=20)\ntitle(\"Residuos Deviance\")\n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/unnamed-chunk-10-1.png){width=90%}\n:::\n:::\n\n\nNão temos indicações claras em nenhum dos dois resíduos\n\n## Modelo de Cox Estratificado\n\nNa eventiualidade de termos um termo claramente violando a proporcionalidade das taxas de falhas, podemos contornar este problema usando a variável como um estrato.\n\n\n::: {.cell}\n\n```{.r .cell-code}\najuste4_E <- coxph(Surv(time, status) ~ sex + strata(ph.ecog), data=dados)\nsummary(ajuste4_E)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> Call:\n#> coxph(formula = Surv(time, status) ~ sex + strata(ph.ecog), data = dados)\n#> \n#>   n= 167, number of events= 120 \n#> \n#>        coef exp(coef) se(coef)      z Pr(>|z|)   \n#> sex -0.5434    0.5807   0.2002 -2.715  0.00664 **\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#>     exp(coef) exp(-coef) lower .95 upper .95\n#> sex    0.5807      1.722    0.3923    0.8598\n#> \n#> Concordance= 0.572  (se = 0.027 )\n#> Likelihood ratio test= 7.75  on 1 df,   p=0.005\n#> Wald test            = 7.37  on 1 df,   p=0.007\n#> Score (logrank) test = 7.54  on 1 df,   p=0.006\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\najuste_aux <- survfit(ajuste4_E)\nplot(ajuste_aux, mark.time=FALSE, col=c(1:4), lwd=3, las=1, bty='n', xlab=\"Tempo (dias)\", ylab=\"S(t)\")\nniveis <- sort(unique(dados$ph.ecog))\nlegend(\"topright\", levels(factor(niveis)), lwd=3, col=c(1:6))\n```\n\n::: {.cell-output-display}\n![](Aula09_files/figure-html/unnamed-chunk-12-1.png){width=90%}\n:::\n:::\n",
    "supporting": [
      "Aula09_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}