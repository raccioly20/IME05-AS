{
  "hash": "32df08f642bee2bb6d0a52c5d2084d1f",
  "result": {
    "markdown": "---\ntitle: \"Análise de Sobrevivência\"\nsubtitle: \"Modelos semi-paramétrico de Cox\"\nauthor: \"Ricardo Accioly\"\nformat: html\n---\n\n\n### Introdução\n\nVamos usar neste exemplo dados da biblioteca survival.\n\nOs dados são de sobrevivência de pacientes com cancer de pulmão em estágio avançado do North Central Cancer Treatment Group.\n\n\\- inst: Códico da Intituição\n\n\\- time: Tempo de sobrevivência em dias\n\n\\- status: 1=censurado, 2=morto\n\n\\- age: Idade em anos\n\n\\- sex: 1=Homem 2 = Mulher\n\n\\- ph.ecog: escore de ECOG definido pelo médico. 0=assintomático, 1= sintomático e no ambulatório, 2= na cama \\<50% do dia, 3= na cama \\> 50% do dia mas não atada a cama, 4 = atado a cama\n\n\\- ph.karno: escore de Karnofsky (ruim=0-bom=100) definido pelo médico\n\n\\- pat.karno: escore de Karnofsky definido pelo paciente\n\n\\- meal.cal: Calorias consumidas nas refeições\n\n\\- wt.loss: Perda de peso nos últimos seis meses (libras)\n\n### Carregando os dados\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(survival)\ndados <- lung\nstr(dados)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n'data.frame':\t228 obs. of  10 variables:\n $ inst     : num  3 3 3 5 1 12 7 11 1 7 ...\n $ time     : num  306 455 1010 210 883 ...\n $ status   : num  2 2 1 2 2 1 2 2 2 2 ...\n $ age      : num  74 68 56 57 60 74 68 71 53 61 ...\n $ sex      : num  1 1 1 1 1 1 2 2 1 1 ...\n $ ph.ecog  : num  1 0 0 1 0 1 2 2 1 2 ...\n $ ph.karno : num  90 90 90 90 100 50 70 60 70 70 ...\n $ pat.karno: num  100 90 90 60 90 80 60 80 80 70 ...\n $ meal.cal : num  1175 1225 NA 1150 NA ...\n $ wt.loss  : num  NA 15 15 11 0 0 10 1 16 34 ...\n```\n:::\n\n```{.r .cell-code}\nsummary(dados)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      inst            time            status           age       \n Min.   : 1.00   Min.   :   5.0   Min.   :1.000   Min.   :39.00  \n 1st Qu.: 3.00   1st Qu.: 166.8   1st Qu.:1.000   1st Qu.:56.00  \n Median :11.00   Median : 255.5   Median :2.000   Median :63.00  \n Mean   :11.09   Mean   : 305.2   Mean   :1.724   Mean   :62.45  \n 3rd Qu.:16.00   3rd Qu.: 396.5   3rd Qu.:2.000   3rd Qu.:69.00  \n Max.   :33.00   Max.   :1022.0   Max.   :2.000   Max.   :82.00  \n NA's   :1                                                       \n      sex           ph.ecog          ph.karno        pat.karno     \n Min.   :1.000   Min.   :0.0000   Min.   : 50.00   Min.   : 30.00  \n 1st Qu.:1.000   1st Qu.:0.0000   1st Qu.: 75.00   1st Qu.: 70.00  \n Median :1.000   Median :1.0000   Median : 80.00   Median : 80.00  \n Mean   :1.395   Mean   :0.9515   Mean   : 81.94   Mean   : 79.96  \n 3rd Qu.:2.000   3rd Qu.:1.0000   3rd Qu.: 90.00   3rd Qu.: 90.00  \n Max.   :2.000   Max.   :3.0000   Max.   :100.00   Max.   :100.00  \n                 NA's   :1        NA's   :1        NA's   :3       \n    meal.cal         wt.loss       \n Min.   :  96.0   Min.   :-24.000  \n 1st Qu.: 635.0   1st Qu.:  0.000  \n Median : 975.0   Median :  7.000  \n Mean   : 928.8   Mean   :  9.832  \n 3rd Qu.:1150.0   3rd Qu.: 15.750  \n Max.   :2600.0   Max.   : 68.000  \n NA's   :47       NA's   :14       \n```\n:::\n:::\n\n\n### Verificação de dados faltantes\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsum(complete.cases(lung))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 167\n```\n:::\n\n```{.r .cell-code}\nlibrary(dplyr)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'dplyr'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:stats':\n\n    filter, lag\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    intersect, setdiff, setequal, union\n```\n:::\n\n```{.r .cell-code}\ndados <- dados %>% na.omit(dados)\nsummary(dados)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      inst            time            status           age       \n Min.   : 1.00   Min.   :   5.0   Min.   :1.000   Min.   :39.00  \n 1st Qu.: 3.00   1st Qu.: 174.5   1st Qu.:1.000   1st Qu.:57.00  \n Median :11.00   Median : 268.0   Median :2.000   Median :64.00  \n Mean   :10.71   Mean   : 309.9   Mean   :1.719   Mean   :62.57  \n 3rd Qu.:15.00   3rd Qu.: 419.5   3rd Qu.:2.000   3rd Qu.:70.00  \n Max.   :32.00   Max.   :1022.0   Max.   :2.000   Max.   :82.00  \n      sex           ph.ecog          ph.karno        pat.karno     \n Min.   :1.000   Min.   :0.0000   Min.   : 50.00   Min.   : 30.00  \n 1st Qu.:1.000   1st Qu.:0.0000   1st Qu.: 70.00   1st Qu.: 70.00  \n Median :1.000   Median :1.0000   Median : 80.00   Median : 80.00  \n Mean   :1.383   Mean   :0.9581   Mean   : 82.04   Mean   : 79.58  \n 3rd Qu.:2.000   3rd Qu.:1.0000   3rd Qu.: 90.00   3rd Qu.: 90.00  \n Max.   :2.000   Max.   :3.0000   Max.   :100.00   Max.   :100.00  \n    meal.cal         wt.loss       \n Min.   :  96.0   Min.   :-24.000  \n 1st Qu.: 619.0   1st Qu.:  0.000  \n Median : 975.0   Median :  7.000  \n Mean   : 929.1   Mean   :  9.719  \n 3rd Qu.:1162.5   3rd Qu.: 15.000  \n Max.   :2600.0   Max.   : 68.000  \n```\n:::\n:::\n\n\n## Modelo Semi-paramétrico de Cox\n\n\n::: {.cell}\n\n```{.r .cell-code}\najuste1 <- coxph(Surv(time, status) ~ age + sex + ph.ecog +\n                   ph.karno + pat.karno + meal.cal, data = dados)\nsummary(ajuste1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\ncoxph(formula = Surv(time, status) ~ age + sex + ph.ecog + ph.karno + \n    pat.karno + meal.cal, data = dados)\n\n  n= 167, number of events= 120 \n\n                coef  exp(coef)   se(coef)      z Pr(>|z|)   \nage        1.220e-02  1.012e+00  1.166e-02  1.046  0.29542   \nsex       -5.096e-01  6.007e-01  2.007e-01 -2.539  0.01113 * \nph.ecog    6.583e-01  1.932e+00  2.223e-01  2.962  0.00305 **\nph.karno   2.195e-02  1.022e+00  1.147e-02  1.913  0.05576 . \npat.karno -8.609e-03  9.914e-01  7.988e-03 -1.078  0.28114   \nmeal.cal   8.125e-06  1.000e+00  2.369e-04  0.034  0.97264   \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n          exp(coef) exp(-coef) lower .95 upper .95\nage          1.0123     0.9879    0.9894    1.0357\nsex          0.6007     1.6647    0.4053    0.8903\nph.ecog      1.9316     0.5177    1.2495    2.9860\nph.karno     1.0222     0.9783    0.9995    1.0454\npat.karno    0.9914     1.0086    0.9760    1.0071\nmeal.cal     1.0000     1.0000    0.9995    1.0005\n\nConcordance= 0.644  (se = 0.03 )\nLikelihood ratio test= 24.63  on 6 df,   p=4e-04\nWald test            = 24.6  on 6 df,   p=4e-04\nScore (logrank) test = 25.25  on 6 df,   p=3e-04\n```\n:::\n\n```{.r .cell-code}\nlogLik(ajuste1)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n'log Lik.' -495.7996 (df=6)\n```\n:::\n:::\n\n\n## Usando o teste de Wald e da razão de verossimilhança\n\nO teste de Wald avalia a estatística z, que no caso acima indica que diversas variáveis não são significativas, por exemplo, meat.cal, age, pat.karno.\n\nVamos eliminar somente meat.cal e fazer o teste da razão de verossimilhança para confirmarmos que ela não é estatísticamente significativa.\n\n\n::: {.cell}\n\n```{.r .cell-code}\najuste2 <- coxph(Surv(time, status) ~ age + sex + ph.ecog +\n                   ph.karno + pat.karno, data = dados)\nlogLik(ajuste2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n'log Lik.' -495.8002 (df=5)\n```\n:::\n\n```{.r .cell-code}\nTRV <- 2*(logLik(ajuste1) - logLik(ajuste2))\npchisq(TRV[1],1, lower.tail = FALSE)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.9726601\n```\n:::\n:::\n\n\nO resultado acima confirma que o modelo não é afetado pela retirada de meat.cal, ou seja, ela não é estatísticamente significativa.\n\n## Automatizando ajuste\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(MASS)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'MASS'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following object is masked from 'package:dplyr':\n\n    select\n```\n:::\n\n```{.r .cell-code}\najuste3 <- stepAIC(ajuste1, direction=\"backward\", trace=FALSE)\nsummary(ajuste3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\ncoxph(formula = Surv(time, status) ~ sex + ph.ecog + ph.karno, \n    data = dados)\n\n  n= 167, number of events= 120 \n\n             coef exp(coef) se(coef)      z Pr(>|z|)    \nsex      -0.53142   0.58777  0.19735 -2.693 0.007085 ** \nph.ecog   0.74917   2.11524  0.21182  3.537 0.000405 ***\nph.karno  0.01778   1.01794  0.01112  1.598 0.110009    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n         exp(coef) exp(-coef) lower .95 upper .95\nsex         0.5878     1.7013    0.3992    0.8653\nph.ecog     2.1152     0.4728    1.3965    3.2038\nph.karno    1.0179     0.9824    0.9960    1.0404\n\nConcordance= 0.637  (se = 0.031 )\nLikelihood ratio test= 22.16  on 3 df,   p=6e-05\nWald test            = 21.94  on 3 df,   p=7e-05\nScore (logrank) test = 22.28  on 3 df,   p=6e-05\n```\n:::\n:::\n\n\nVeja que ph.karno é marginalmente significativa, pois seu p-valor é maior que 0,10, o maior nível de significância usualmente adotado.\n\n## Informações do Ajuste\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoef(ajuste3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n        sex     ph.ecog    ph.karno \n-0.53141941  0.74916725  0.01777643 \n```\n:::\n\n```{.r .cell-code}\nlogLik(ajuste3)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n'log Lik.' -497.0362 (df=3)\n```\n:::\n:::\n\n\n## Tempos Idênticos\n\n\n::: {.cell}\n\n```{.r .cell-code}\najuste4 <- coxph(Surv(time,status==2) ~ sex + ph.ecog + ph.karno , \n                 ties= \"efron\", \n                 data=dados)\najuste5 <- coxph(Surv(time,status==2) ~ sex + ph.ecog + ph.karno , \n                 ties= \"breslow\", \n                 data=dados)\najuste6 <- coxph(Surv(time,status==2) ~ sex + ph.ecog + ph.karno , \n                 ties= \"exact\", \n                 data=dados)\ndif_met <- rbind(coef(ajuste4), coef(ajuste5), coef(ajuste6))\nrow.names(dif_met) <- c(\"Efron\", \"Breslow\", \"Exact\")\nknitr::kable(dif_met)\n```\n\n::: {.cell-output-display}\n|        |        sex|   ph.ecog|  ph.karno|\n|:-------|----------:|---------:|---------:|\n|Efron   | -0.5314194| 0.7491673| 0.0177764|\n|Breslow | -0.5306768| 0.7487334| 0.0177595|\n|Exact   | -0.5316889| 0.7502275| 0.0177955|\n:::\n:::\n\n\n## Avaliando Ajuste\n\n\n::: {.cell}\n\n```{.r .cell-code}\nav1 <- survfit(Surv(time, status) ~ sex, data = dados)\nav1.tab <- summary(av1)\nplot(av1.tab$time,log(-log(av1.tab$surv)),\ncol = av1.tab$strata, xlab = \"log(t)\", ylab = \"log(-log(S))\",\npch = 20)\nlegend(\"bottomright\", bty = \"n\", lty = 1, col = c(1:2),\nlegend = sprintf(\"Sexo %d\", 1:2))\n```\n\n::: {.cell-output-display}\n![](Aula08_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\nav2 <- survfit(Surv(time, status) ~ ph.ecog, data = dados)\nav2.tab <- summary(av2)\nplot(av2.tab$time,log(-log(av2.tab$surv)),\ncol = av2.tab$strata, xlab = \"log(t)\", ylab = \"log(-log(S))\",\npch = 20)\nlegend(\"bottomright\", bty = \"n\", lty = 1, col = c(1,2,3),\nlegend = sprintf(\"Ecog %d\", 0:2))\n```\n\n::: {.cell-output-display}\n![](Aula08_files/figure-html/unnamed-chunk-6-2.png){width=672}\n:::\n:::\n\n\n## Resíduos de Cox-Snell\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(car)\ncox.snell <- abs(dados$status - ajuste4$residuals)\nqqPlot(cox.snell, dist = \"exp\", rate = mean(cox.snell))\n```\n\n::: {.cell-output-display}\n![](Aula08_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n37 18 \n25 11 \n```\n:::\n:::\n\n\n## Resíduos de Schoenfeld\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncox.zph(ajuste4)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n         chisq df      p\nsex      0.875  1 0.3496\nph.ecog  4.998  1 0.0254\nph.karno 7.366  1 0.0066\nGLOBAL   7.969  3 0.0467\n```\n:::\n\n```{.r .cell-code}\nresid.sch <- cox.zph(ajuste4)\npar(mfrow=c(1,3))\nplot(resid.sch)\n```\n\n::: {.cell-output-display}\n![](Aula08_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n## Modelo de Cox Estratificado\n\n\n::: {.cell}\n\n```{.r .cell-code}\najuste4_E <- coxph(Surv(time, status) ~ sex + ph.ecog + strata(ph.karno), data=dados)\nsummary(ajuste4_E)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\ncoxph(formula = Surv(time, status) ~ sex + ph.ecog + strata(ph.karno), \n    data = dados)\n\n  n= 167, number of events= 120 \n\n           coef exp(coef) se(coef)      z Pr(>|z|)   \nsex     -0.5785    0.5607   0.2023 -2.859  0.00425 **\nph.ecog  0.5504    1.7339   0.2412  2.282  0.02251 * \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n        exp(coef) exp(-coef) lower .95 upper .95\nsex        0.5607     1.7834    0.3772    0.8337\nph.ecog    1.7339     0.5767    1.0807    2.7821\n\nConcordance= 0.606  (se = 0.03 )\nLikelihood ratio test= 13.79  on 2 df,   p=0.001\nWald test            = 13.25  on 2 df,   p=0.001\nScore (logrank) test = 13.55  on 2 df,   p=0.001\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\najuste_aux <- survfit(ajuste4_E)\nplot(ajuste_aux, mark.time=FALSE, col=c(1:6), lwd=3, las=1, bty='n', xlab=\"Tempo (dias)\", ylab=\"S(t)\")\nniveis <- sort(unique(dados$ph.karno))\nlegend(\"topright\", levels(factor(niveis)), lwd=3, col=c(1:6))\n```\n\n::: {.cell-output-display}\n![](Aula08_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "Aula08_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}