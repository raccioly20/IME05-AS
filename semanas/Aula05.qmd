---
title: "An√°lise de Sobreviv√™ncia"
subtitle: "Modelos Param√©tricos - Verifica√ß√£o do Ajuste"
author: "Ricardo Accioly"
format:
 html:
    code-link: true
    fig-width: 9
    fig-height: 7
    fig-dpi: 300
knitr:
  opts_chunk: 
    out.width: 90%
    comment: "#>"
---

```{r setup}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5
```

## Modelos Param√©tricos

Neste exemplo s√£o considerados os tempos de reincid√™ncia, em meses, de um grupo de 20 pacientes com cancer de bexiga que foram submetidos a um procedimento cirurgico feito por laser.

Nesta apresenta√ß√£o vamos verificar graficamente atrav√©s de gr√°ficos Q-Q se os modelos exponencial, Weibull, lognormal e log-log√≠stico parecem ser adequados.

Aqui vamos utilizar as fun√ß√µes existentes no pacote `survival`.

Para ajustar um modelo param√©trico usamos a fun√ß√£o `survreg`.

## Metodo Kaplan-Meier

```{r}
library(survival)
tempos<-c(3,5,6,7,8,9,10,10,12,15,15,18,19,20,22,25,28,30,40,45)
cens<-c(1,1,1,1,1,1,1,0,1,1,0,1,1,1,1,1,1,1,1,0)
dados <- data.frame(tempos=tempos, status=cens)
ekm <- survfit(Surv(tempos,status)~1, data=dados)
summary(ekm)
```

## Curva de Sobreviv√™ncia N√£o param√©trica

```{r}
plot(ekm, xlab="Tempo (meses)",ylab="S(t) estimada")
```

## Modelos Param√©tricos

```{r}
ajustExp <- survreg(Surv(tempos,status)~1, data=dados, dist='exponential')
alfa <- exp(ajustExp$coefficients[1])
ajustWei <- survreg(Surv(tempos,status)~1, data=dados, dist='weibull')
alfaw <- exp(ajustWei$coefficients[1])
betaw <- 1/ajustWei$scale
ajustLog <- survreg(Surv(tempos,status)~1, data=dados, dist='lognorm')
mu <- ajustLog$icoef[1]
sigma <- exp(ajustLog$icoef[2])
ajustLogl <- survreg(Surv(tempos,status)~1, data=dados, dist='loglogistic')
mu1 <- ajustLogl$icoef[1]
sigma1 <- exp(ajustLogl$icoef[2])

```

\`

## Avalia√ß√£o do Modelo Weibull

```{r}
tab.np <- summary(ekm)
plot(log(-log(tab.np$surv)) ~ log(tab.np$time),
     xlab="log(t)", ylab="log(-log(S(t)))", pch=20)
mod1.lm <- lm(log(-log(tab.np$surv)) ~ log(tab.np$time))
abline(mod1.lm)
confint(mod1.lm)
```

## Avalia√ß√£o do Modelo Lognormal

```{r}
tab.np <- summary(ekm)
invst1 <- qnorm(tab.np$surv)
plot(invst1 ~ log(tab.np$time),
     xlab="log(t)", ylab=expression(Phi^-1*(S(t))), pch=20)
mod2.lm <- lm(invst1 ~ log(tab.np$time))
abline(mod2.lm)
```

## Avalia√ß√£o do Modelo LogLog√≠stico

```{r}
tab.np <- summary(ekm)
invst2 <- qlogis(tab.np$surv) 
plot(invst2 ~ log(tab.np$time),
     xlab="log(t)", ylab=expression(Phi^-1*Logis*(S(t))), pch=20)
mod3.lm <- lm(invst2 ~ log(tab.np$time))
abline(mod3.lm)
```

## Teste de Raz√£o de Verossimilhan√ßa {.smaller}

No n√≠vel de signific√¢ncia de ùõº=0,05 eu rejeito a hip√≥tese de que o parametro de forma seja igual a 1.

```{r}
tab.exp <- summary(ajustExp)
tab.exp
tab.wei <- summary(ajustWei)
tab.wei
TRV <- 2*(tab.wei$loglik[1] - tab.exp$loglik[1])
pchisq(TRV, 1, lower.tail = F)
```

## Comparando modelos atrav√©s do AIC {.smaller}

```{r}
#| echo: true
#| fig-width: 10
#| fig-height: 4.5
tab.exp <- summary(ajustExp)
tab.wei <- summary(ajustWei)
tab.ln <- summary(ajustLog)
tab.ll <- summary(ajustLogl)
aic.exp <- -2*tab.exp$loglik[1] + 2*1
aic.exp
aic.wei <- -2*tab.wei$loglik[1] + 2*2
aic.wei
aic.ln <- -2*tab.ln$loglik[1] + 2*2
aic.ln
aic.ll <- -2*tab.ll$loglik[1] + 2*2
aic.ll
aic <- c(aic.exp, aic.wei, aic.ln, aic.ll)
delta.aic <- aic - min(aic)
delta.aic
peso.aic <- exp(-0.5*delta.aic)/sum(exp(-0.5*delta.aic))
sum(peso.aic)
```

## Comparando modleos atrav√©s do Peso de Akaike

```{r}
modelos <- data.frame(modelos=c("Exponencial", "Weibull",
                                "Lognormal", "Loglogistico"),
                      p_Akaike = peso.aic)
gt::gt(modelos)
```
